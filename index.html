<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>烤肉準備工作區 - 莫蘭迪風格</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, 
                #f5f2f0 0%, 
                #ede7e0 25%, 
                #e8ddd4 50%, 
                #e2d6ca 75%, 
                #ddd0c0 100%);
            min-height: 100vh;
            color: #6b5b6f;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(215, 204, 200, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(205, 195, 185, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 40% 80%, rgba(195, 185, 175, 0.2) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            background: rgba(245, 240, 235, 0.6);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 30px;
            box-shadow: 
                0 8px 32px rgba(139, 131, 134, 0.1),
                0 4px 16px rgba(139, 131, 134, 0.05),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(215, 204, 200, 0.2);
        }

        .event-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: #8b8386;
            margin-bottom: 15px;
            text-shadow: 0 2px 4px rgba(139, 131, 134, 0.1);
        }

        .event-date {
            font-size: 1.3rem;
            color: #a69ca0;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .event-address {
            font-size: 1.1rem;
            color: #b8aeb3;
            font-weight: 400;
        }

        .debug-info {
            background: rgba(255, 245, 245, 0.8);
            border: 1px solid rgba(255, 180, 180, 0.3);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            color: #8b4513;
            display: none;
        }

        .debug-info.show {
            display: block;
        }

        .main-content {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 30px;
            align-items: start;
        }

        .add-section {
            background: rgba(240, 235, 230, 0.7);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 
                0 8px 32px rgba(139, 131, 134, 0.1),
                0 4px 16px rgba(139, 131, 134, 0.05),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(215, 204, 200, 0.3);
            position: sticky;
            top: 20px;
        }

        .add-section h2 {
            color: #8b8386;
            font-size: 1.4rem;
            margin-bottom: 25px;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #9d9396;
            font-weight: 500;
            font-size: 0.95rem;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1.5px solid rgba(205, 195, 190, 0.4);
            border-radius: 12px;
            background: rgba(248, 245, 242, 0.8);
            backdrop-filter: blur(10px);
            color: #7a6d70;
            font-size: 1rem;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: rgba(165, 155, 150, 0.6);
            background: rgba(250, 247, 244, 0.9);
            box-shadow: 0 0 0 3px rgba(165, 155, 150, 0.1);
        }

        .btn-add {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #c9bbb0 0%, #b8a99e 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            box-shadow: 
                0 4px 12px rgba(139, 131, 134, 0.2),
                0 2px 4px rgba(139, 131, 134, 0.1);
        }

        .btn-add:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 6px 20px rgba(139, 131, 134, 0.25),
                0 4px 8px rgba(139, 131, 134, 0.15);
        }

        .btn-add:active {
            transform: translateY(0);
        }

        .btn-debug {
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            background: linear-gradient(135deg, #d4c5c7 0%, #c9b8ba 100%);
            color: #8b7d7f;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .list-section {
            background: rgba(250, 247, 244, 0.6);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 
                0 8px 32px rgba(139, 131, 134, 0.1),
                0 4px 16px rgba(139, 131, 134, 0.05),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(215, 204, 200, 0.3);
        }

        .list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .list-section h2 {
            color: #8b8386;
            font-size: 1.4rem;
            font-weight: 600;
        }

        .filter-container {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .filter-select {
            min-width: 120px;
            padding: 8px 12px;
            border: 1.5px solid rgba(205, 195, 190, 0.4);
            border-radius: 8px;
            background: rgba(248, 245, 242, 0.8);
            color: #7a6d70;
            font-size: 0.9rem;
        }

        .task-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255, 255, 255, 0.4);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 
                0 4px 16px rgba(139, 131, 134, 0.08),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        .task-table th {
            background: linear-gradient(135deg, rgba(220, 210, 200, 0.7) 0%, rgba(210, 200, 190, 0.7) 100%);
            color: #8b8386;
            padding: 16px;
            text-align: left;
            font-weight: 600;
            font-size: 0.95rem;
            border-bottom: 1px solid rgba(205, 195, 190, 0.2);
        }

        .task-table td {
            padding: 16px;
            border-bottom: 1px solid rgba(205, 195, 190, 0.1);
            color: #7a6d70;
        }

        .task-table tr:hover {
            background: rgba(245, 240, 235, 0.5);
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-block;
            min-width: 70px;
            text-align: center;
        }

        .status-pending {
            background: linear-gradient(135deg, #d4c5c7 0%, #c9b8ba 100%);
            color: #8b7d7f;
        }

        .status-in-progress {
            background: linear-gradient(135deg, #c7d0c4 0%, #bcc7b9 100%);
            color: #7a8677;
        }

        .status-completed {
            background: linear-gradient(135deg, #b8c4d0 0%, #adb9c7 100%);
            color: #6d7a86;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .btn-edit, .btn-delete {
            padding: 6px 12px;
            border: none;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-edit {
            background: linear-gradient(135deg, #c9bbb0 0%, #b8a99e 100%);
            color: white;
        }

        .btn-delete {
            background: linear-gradient(135deg, #d0b8b8 0%, #c7a9a9 100%);
            color: white;
        }

        .btn-edit:hover, .btn-delete:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(139, 131, 134, 0.2);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(139, 131, 134, 0.4);
            backdrop-filter: blur(10px);
        }

        .modal-content {
            background: linear-gradient(135deg, rgba(250, 247, 244, 0.95) 0%, rgba(245, 240, 235, 0.95) 100%);
            backdrop-filter: blur(30px);
            margin: 5% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            box-shadow: 
                0 20px 60px rgba(139, 131, 134, 0.3),
                0 8px 32px rgba(139, 131, 134, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            border: 1px solid rgba(215, 204, 200, 0.3);
        }

        .close {
            color: #a69ca0;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            color: #8b8386;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #a69ca0;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .loading {
            text-align: center;
            padding: 40px 20px;
            color: #a69ca0;
        }

        .error-state {
            text-align: center;
            padding: 40px 20px;
            color: #d0b8b8;
            background: rgba(255, 245, 245, 0.5);
            border-radius: 12px;
            border: 1px solid rgba(255, 180, 180, 0.2);
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .add-section {
                position: static;
            }
            
            .event-title {
                font-size: 2rem;
            }
            
            .filter-container {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="event-title">烤肉準備工作區</h1>
            <div class="event-date">活動：9/28(日)下午15:30 闔家烤肉萬家香</div>
            <div class="event-address">地址：新北市林口區仁愛路一段667巷23號</div>
        </div>

        <div id="debugInfo" class="debug-info">
            <strong>調試信息：</strong><br>
            <div id="debugContent"></div>
        </div>

        <div class="main-content">
            <div class="add-section">
                <h2>新增準備事項</h2>
                <form id="taskForm">
                    <div class="form-group">
                        <label for="itemName">事項名稱</label>
                        <input type="text" id="itemName" name="itemName" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="category">分類</label>
                        <select id="category" name="category" required>
                            <option value="">選擇分類</option>
                            <option value="食材">食材</option>
                            <option value="器具">器具</option>
                            <option value="調料">調料</option>
                            <option value="其他">其他</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="quantity">數量</label>
                        <input type="text" id="quantity" name="quantity" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="responsible">負責人</label>
                        <input type="text" id="responsible" name="responsible" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="notes">備註</label>
                        <textarea id="notes" name="notes" rows="3"></textarea>
                    </div>
                    
                    <button type="submit" class="btn-add">新增事項</button>
                    <button type="button" class="btn-debug" onclick="toggleDebug()">顯示調試信息</button>
                </form>
            </div>

            <div class="list-section">
                <div class="list-header">
                    <h2>準備清單</h2>
                    <div class="filter-container">
                        <select id="statusFilter" class="filter-select">
                            <option value="">所有狀態</option>
                            <option value="待處理">待處理</option>
                            <option value="進行中">進行中</option>
                            <option value="已完成">已完成</option>
                        </select>
                        <select id="categoryFilter" class="filter-select">
                            <option value="">所有分類</option>
                            <option value="食材">食材</option>
                            <option value="器具">器具</option>
                            <option value="調料">調料</option>
                            <option value="其他">其他</option>
                        </select>
                    </div>
                </div>
                
                <div id="taskList">
                    <div class="loading">
                        <div style="font-size: 2rem; margin-bottom: 15px;">⏳</div>
                        <p>正在載入數據...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 style="color: #8b8386; margin-bottom: 20px;">編輯事項</h2>
            <form id="editForm">
                <div class="form-group">
                    <label for="editItemName">事項名稱</label>
                    <input type="text" id="editItemName" name="itemName" required>
                </div>
                
                <div class="form-group">
                    <label for="editCategory">分類</label>
                    <select id="editCategory" name="category" required>
                        <option value="食材">食材</option>
                        <option value="器具">器具</option>
                        <option value="調料">調料</option>
                        <option value="其他">其他</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="editQuantity">數量</label>
                    <input type="text" id="editQuantity" name="quantity" required>
                </div>
                
                <div class="form-group">
                    <label for="editResponsible">負責人</label>
                    <input type="text" id="editResponsible" name="responsible" required>
                </div>
                
                <div class="form-group">
                    <label for="editNotes">備註</label>
                    <textarea id="editNotes" name="notes" rows="3"></textarea>
                </div>
                
                <button type="submit" class="btn-add">保存變更</button>
            </form>
        </div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbxRK7Q2jL7bGDigcuL6XHthkH1PJPtEEaWarfl-DDTw9CBU7FI80Rl80mVJSLpmV7ac/exec';
        let tasks = [];
        let editingRowIndex = null;
        let debugMode = false;

        // Debug functions
        function log(message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            console.log(logMessage, data || '');
            
            if (debugMode) {
                const debugContent = document.getElementById('debugContent');
                const logEntry = document.createElement('div');
                logEntry.innerHTML = `${logMessage}${data ? ' ' + JSON.stringify(data, null, 2) : ''}`;
                debugContent.appendChild(logEntry);
                debugContent.scrollTop = debugContent.scrollHeight;
            }
        }

        function toggleDebug() {
            debugMode = !debugMode;
            const debugInfo = document.getElementById('debugInfo');
            const btn = event.target;
            
            if (debugMode) {
                debugInfo.classList.add('show');
                btn.textContent = '隱藏調試信息';
                log('調試模式已開啟');
            } else {
                debugInfo.classList.remove('show');
                btn.textContent = '顯示調試信息';
                document.getElementById('debugContent').innerHTML = '';
            }
        }

        // DOM Elements
        const taskForm = document.getElementById('taskForm');
        const taskList = document.getElementById('taskList');
        const statusFilter = document.getElementById('statusFilter');
        const categoryFilter = document.getElementById('categoryFilter');
        const editModal = document.getElementById('editModal');
        const editForm = document.getElementById('editForm');
        const closeModal = document.querySelector('.close');

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            log('頁面載入完成，開始初始化');
            
            // Add timeout for loading
            setTimeout(() => {
                if (tasks.length === 0) {
                    showError('載入超時，請檢查網絡連接或重新整理頁面');
                }
            }, 10000);
            
            loadTasks();
            
            taskForm.addEventListener('submit', handleAddTask);
            editForm.addEventListener('submit', handleEditSubmit);
            statusFilter.addEventListener('change', renderTasks);
            categoryFilter.addEventListener('change', renderTasks);
            
            closeModal.addEventListener('click', closeEditModal);
            window.addEventListener('click', function(event) {
                if (event.target === editModal) {
                    closeEditModal();
                }
            });
        });

        // Load tasks from Google Apps Script
        function loadTasks() {
            log('開始載入任務數據');
            
            try {
                const callbackName = 'handleTasksLoaded_' + Date.now();
                const script = document.createElement('script');
                const url = `${API_URL}?action=read&callback=${callbackName}`;
                
                log('發送JSONP請求', { url: url });
                
                // Create global callback function
                window[callbackName] = function(data) {
                    log('收到回調數據', data);
                    
                    // Clean up
                    document.head.removeChild(script);
                    delete window[callbackName];
                    
                    handleTasksLoaded(data);
                };
                
                // Set up error handling
                script.onerror = function() {
                    log('腳本載入錯誤');
                    showError('無法連接到服務器，請檢查網絡連接');
                    document.head.removeChild(script);
                    delete window[callbackName];
                };
                
                script.src = url;
                document.head.appendChild(script);
                
            } catch (error) {
                log('載入任務時發生錯誤', error);
                showError('載入數據時發生錯誤: ' + error.message);
            }
        }

        // Handle loaded tasks
        function handleTasksLoaded(data) {
            log('處理載入的任務數據', data);
            
            if (!data) {
                log('收到空數據');
                showError('服務器返回空數據，請稍後再試');
                return;
            }
            
            if (data.success) {
                tasks = data.data || [];
                log('任務載入成功', { count: tasks.length });
                renderTasks();
            } else {
                const errorMsg = data.message || '未知錯誤';
                log('載入失敗', { message: errorMsg });
                showError('載入資料失敗: ' + errorMsg);
            }
        }

        // Show error message
        function showError(message) {
            taskList.innerHTML = `
                <div class="error-state">
                    <div style="font-size: 2rem; margin-bottom: 15px;">⚠️</div>
                    <p><strong>載入失敗</strong></p>
                    <p>${message}</p>
                    <button style="margin-top: 15px; padding: 8px 16px; background: #c7a9a9; color: white; border: none; border-radius: 8px; cursor: pointer;" onclick="loadTasks()">重新載入</button>
                </div>
            `;
        }

        // Handle add task form submission
        function handleAddTask(e) {
            e.preventDefault();
            log('提交新增任務表單');
            
            const formData = new FormData(taskForm);
            const taskData = {
                itemName: formData.get('itemName'),
                category: formData.get('category'),
                quantity: formData.get('quantity'),
                responsible: formData.get('responsible'),
                notes: formData.get('notes') || '',
                status: '待處理'
            };

            log('新增任務數據', taskData);
            addTask(taskData);
        }

        // Add task via JSONP
        function addTask(taskData) {
            try {
                const callbackName = 'handleAddResult_' + Date.now();
                const params = new URLSearchParams({
                    action: 'add',
                    callback: callbackName,
                    ...taskData
                });
                
                const url = `${API_URL}?${params}`;
                log('發送新增請求', { url: url });
                
                window[callbackName] = function(data) {
                    log('收到新增結果', data);
                    document.head.removeChild(script);
                    delete window[callbackName];
                    handleAddResult(data);
                };
                
                const script = document.createElement('script');
                script.onerror = function() {
                    log('新增請求腳本錯誤');
                    alert('新增失敗：網絡錯誤');
                    document.head.removeChild(script);
                    delete window[callbackName];
                };
                
                script.src = url;
                document.head.appendChild(script);
                
            } catch (error) {
                log('新增任務時發生錯誤', error);
                alert('新增失敗: ' + error.message);
            }
        }

        // Callback for add task result
        function handleAddResult(data) {
            if (data && data.success) {
                taskForm.reset();
                loadTasks(); // Reload tasks
                alert('新增成功！');
            } else {
                const errorMsg = data ? data.message : '未知錯誤';
                log('新增失敗', { message: errorMsg });
                alert('新增失敗: ' + errorMsg);
            }
        }

        // Render tasks table
        function renderTasks() {
            log('渲染任務列表', { taskCount: tasks.length });
            
            const statusFilterValue = statusFilter.value;
            const categoryFilterValue = categoryFilter.value;
            
            let filteredTasks = tasks;
            
            if (statusFilterValue) {
                filteredTasks = filteredTasks.filter(task => task.status === statusFilterValue);
            }
            
            if (categoryFilterValue) {
                filteredTasks = filteredTasks.filter(task => task.category === categoryFilterValue);
            }

            if (filteredTasks.length === 0) {
                taskList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">🔥</div>
                        <p>${tasks.length === 0 ? '還沒有準備事項，趕快新增吧！' : '沒有符合篩選條件的事項'}</p>
                    </div>
                `;
                return;
            }

            const tableHTML = `
                <table class="task-table">
                    <thead>
                        <tr>
                            <th>事項名稱</th>
                            <th>分類</th>
                            <th>數量</th>
                            <th>負責人</th>
                            <th>狀態</th>
                            <th>備註</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredTasks.map((task, index) => {
                            const originalIndex = tasks.findIndex(t => 
                                t.itemName === task.itemName && 
                                t.category === task.category && 
                                t.responsible === task.responsible
                            );
                            return `
                                <tr>
                                    <td>${task.itemName || ''}</td>
                                    <td>${task.category || ''}</td>
                                    <td>${task.quantity || ''}</td>
                                    <td>${task.responsible || ''}</td>
                                    <td>
                                        <span class="status-badge ${getStatusClass(task.status)}" 
                                              onclick="changeStatus(${originalIndex})">
                                            ${task.status || '待處理'}
                                        </span>
                                    </td>
                                    <td>${task.notes || ''}</td>
                                    <td>
                                        <div class="action-buttons">
                                            <button class="btn-edit" onclick="handleEditClick(${originalIndex})">編輯</button>
                                            <button class="btn-delete" onclick="handleDeleteClick(${originalIndex})">刪除</button>
                                        </div>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            
            taskList.innerHTML = tableHTML;
        }

        // Get status CSS class
        function getStatusClass(status) {
            switch(status) {
                case '待處理': return 'status-pending';
                case '進行中': return 'status-in-progress';
                case '已完成': return 'status-completed';
                default: return 'status-pending';
            }
        }

        // Change task status
        function changeStatus(rowIndex) {
            log('更改狀態', { rowIndex: rowIndex });
            
            if (rowIndex < 0 || rowIndex >= tasks.length) {
                log('無效的行索引', { rowIndex: rowIndex, tasksLength: tasks.length });
                return;
            }

            const currentStatus = tasks[rowIndex].status;
            let newStatus;
            
            switch(currentStatus) {
                case '待處理':
                    newStatus = '進行中';
                    break;
                case '進行中':
                    newStatus = '已完成';
                    break;
                case '已完成':
                    newStatus = '待處理';
                    break;
                default:
                    newStatus = '進行中';
            }

            updateStatus(rowIndex, newStatus);
        }

        // Update status via JSONP
        function updateStatus(rowIndex, newStatus) {
            try {
                const callbackName = 'handleUpdateStatusResult_' + Date.now();
                const params = new URLSearchParams({
                    action: 'updateStatus',
                    callback: callbackName,
                    rowIndex: rowIndex + 2,
                    status: newStatus
                });
                
                const url = `${API_URL}?${params}`;
                log('發送狀態更新請求', { url: url, rowIndex: rowIndex, newStatus: newStatus });
                
                window[callbackName] = function(data) {
                    log('收到狀態更新結果', data);
                    document.head.removeChild(script);
                    delete window[callbackName];
                    handleUpdateStatusResult(data);
                };
                
                const script = document.createElement('script');
                script.onerror = function() {
                    log('狀態更新腳本錯誤');
                    alert('更新狀態失敗：網絡錯誤');
                    document.head.removeChild(script);
                    delete window[callbackName];
                };
                
                script.src = url;
                document.head.appendChild(script);
                
            } catch (error) {
                log('更新狀態時發生錯誤', error);
                alert('更新狀態失敗: ' + error.message);
            }
        }

        // Callback for update status result
        function handleUpdateStatusResult(data) {
            if (data && data.success) {
                loadTasks(); // Reload tasks
            } else {
                const errorMsg = data ? data.message : '未知錯誤';
                log('更新狀態失敗', { message: errorMsg });
                alert('更新狀態失敗: ' + errorMsg);
            }
        }

        // Handle edit button click
        function handleEditClick(rowIndex) {
            log('點擊編輯按鈕', { rowIndex: rowIndex });
            
            if (rowIndex < 0 || rowIndex >= tasks.length) {
                log('無效的編輯行索引', { rowIndex: rowIndex, tasksLength: tasks.length });
                return;
            }

            editingRowIndex = rowIndex;
            const task = tasks[rowIndex];
            
            document.getElementById('editItemName').value = task.itemName || '';
            document.getElementById('editCategory').value = task.category || '';
            document.getElementById('editQuantity').value = task.quantity || '';
            document.getElementById('editResponsible').value = task.responsible || '';
            document.getElementById('editNotes').value = task.notes || '';
            
            editModal.style.display = 'block';
        }

        // Handle edit form submission
        function handleEditSubmit(e) {
            e.preventDefault();
            log('提交編輯表單', { editingRowIndex: editingRowIndex });
            
            if (editingRowIndex === null) return;
            
            const formData = new FormData(editForm);
            const updatedTask = {
                itemName: formData.get('itemName'),
                category: formData.get('category'),
                quantity: formData.get('quantity'),
                responsible: formData.get('responsible'),
                notes: formData.get('notes') || ''
            };

            editTask(editingRowIndex, updatedTask);
        }

        // Edit task via JSONP
        function editTask(rowIndex, taskData) {
            try {
                const callbackName = 'handleEditResult_' + Date.now();
                const params = new URLSearchParams({
                    action: 'edit',
                    callback: callbackName,
                    rowIndex: rowIndex + 2,
                    ...taskData
                });
                
                const url = `${API_URL}?${params}`;
                log('發送編輯請求', { url: url, rowIndex: rowIndex, taskData: taskData });
                
                window[callbackName] = function(data) {
                    log('收到編輯結果', data);
                    document.head.removeChild(script);
                    delete window[callbackName];
                    handleEditResult(data);
                };
                
                const script = document.createElement('script');
                script.onerror = function() {
                    log('編輯請求腳本錯誤');
                    alert('編輯失敗：網絡錯誤');
                    document.head.removeChild(script);
                    delete window[callbackName];
                };
                
                script.src = url;
                document.head.appendChild(script);
                
            } catch (error) {
                log('編輯任務時發生錯誤', error);
                alert('編輯失敗: ' + error.message);
            }
        }

        // Callback for edit task result
        function handleEditResult(data) {
            if (data && data.success) {
                closeEditModal();
                loadTasks(); // Reload tasks
                alert('編輯成功！');
            } else {
                const errorMsg = data ? data.message : '未知錯誤';
                log('編輯失敗', { message: errorMsg });
                alert('編輯失敗: ' + errorMsg);
            }
        }

        // Handle delete button click
        function handleDeleteClick(rowIndex) {
            log('點擊刪除按鈕', { rowIndex: rowIndex });
            
            if (rowIndex < 0 || rowIndex >= tasks.length) {
                log('無效的刪除行索引', { rowIndex: rowIndex, tasksLength: tasks.length });
                return;
            }

            const task = tasks[rowIndex];
            if (confirm(`確定要刪除「${task.itemName}」嗎？`)) {
                deleteTask(rowIndex);
            }
        }

        // Delete task via JSONP
        function deleteTask(rowIndex) {
            try {
                const callbackName = 'handleDeleteResult_' + Date.now();
                const params = new URLSearchParams({
                    action: 'delete',
                    callback: callbackName,
                    rowIndex: rowIndex + 2
                });
                
                const url = `${API_URL}?${params}`;
                log('發送刪除請求', { url: url, rowIndex: rowIndex });
                
                window[callbackName] = function(data) {
                    log('收到刪除結果', data);
                    document.head.removeChild(script);
                    delete window[callbackName];
                    handleDeleteResult(data);
                };
                
                const script = document.createElement('script');
                script.onerror = function() {
                    log('刪除請求腳本錯誤');
                    alert('刪除失敗：網絡錯誤');
                    document.head.removeChild(script);
                    delete window[callbackName];
                };
                
                script.src = url;
                document.head.appendChild(script);
                
            } catch (error) {
                log('刪除任務時發生錯誤', error);
                alert('刪除失敗: ' + error.message);
            }
        }

        // Callback for delete task result
        function handleDeleteResult(data) {
            if (data && data.success) {
                loadTasks(); // Reload tasks
                alert('刪除成功！');
            } else {
                const errorMsg = data ? data.message : '未知錯誤';
                log('刪除失敗', { message: errorMsg });
                alert('刪除失敗: ' + errorMsg);
            }
        }

        // Close edit modal
        function closeEditModal() {
            editModal.style.display = 'none';
            editingRowIndex = null;
            editForm.reset();
        }
    </script>
</body>
</html>
