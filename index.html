<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>烤肉準備工作區 - 莫蘭迪風格</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, 
                #f5f2f0 0%, 
                #ede7e0 25%, 
                #e8ddd4 50%, 
                #e2d6ca 75%, 
                #ddd0c0 100%);
            min-height: 100vh;
            color: #6b5b6f;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(215, 204, 200, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(205, 195, 185, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 40% 80%, rgba(195, 185, 175, 0.2) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            background: rgba(245, 240, 235, 0.6);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 30px;
            box-shadow: 
                0 8px 32px rgba(139, 131, 134, 0.1),
                0 4px 16px rgba(139, 131, 134, 0.05),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(215, 204, 200, 0.2);
        }

        .event-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: #8b8386;
            margin-bottom: 15px;
            text-shadow: 0 2px 4px rgba(139, 131, 134, 0.1);
        }

        .event-date {
            font-size: 1.3rem;
            color: #a69ca0;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .event-address {
            font-size: 1.1rem;
            color: #b8aeb3;
            font-weight: 400;
        }

        .main-content {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 30px;
            align-items: start;
        }

        .add-section {
            background: rgba(240, 235, 230, 0.7);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 
                0 8px 32px rgba(139, 131, 134, 0.1),
                0 4px 16px rgba(139, 131, 134, 0.05),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(215, 204, 200, 0.3);
            position: sticky;
            top: 20px;
        }

        .add-section h2 {
            color: #8b8386;
            font-size: 1.4rem;
            margin-bottom: 25px;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #9d9396;
            font-weight: 500;
            font-size: 0.95rem;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1.5px solid rgba(205, 195, 190, 0.4);
            border-radius: 12px;
            background: rgba(248, 245, 242, 0.8);
            backdrop-filter: blur(10px);
            color: #7a6d70;
            font-size: 1rem;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: rgba(165, 155, 150, 0.6);
            background: rgba(250, 247, 244, 0.9);
            box-shadow: 0 0 0 3px rgba(165, 155, 150, 0.1);
        }

        .btn-add {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #c9bbb0 0%, #b8a99e 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            box-shadow: 
                0 4px 12px rgba(139, 131, 134, 0.2),
                0 2px 4px rgba(139, 131, 134, 0.1);
        }

        .btn-add:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 6px 20px rgba(139, 131, 134, 0.25),
                0 4px 8px rgba(139, 131, 134, 0.15);
        }

        .btn-add:active {
            transform: translateY(0);
        }

        .list-section {
            background: rgba(250, 247, 244, 0.6);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 
                0 8px 32px rgba(139, 131, 134, 0.1),
                0 4px 16px rgba(139, 131, 134, 0.05),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(215, 204, 200, 0.3);
        }

        .list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .list-section h2 {
            color: #8b8386;
            font-size: 1.4rem;
            font-weight: 600;
        }

        .filter-container {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .filter-select {
            min-width: 120px;
            padding: 8px 12px;
            border: 1.5px solid rgba(205, 195, 190, 0.4);
            border-radius: 8px;
            background: rgba(248, 245, 242, 0.8);
            color: #7a6d70;
            font-size: 0.9rem;
        }

        .task-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255, 255, 255, 0.4);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 
                0 4px 16px rgba(139, 131, 134, 0.08),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        .task-table th {
            background: linear-gradient(135deg, rgba(220, 210, 200, 0.7) 0%, rgba(210, 200, 190, 0.7) 100%);
            color: #8b8386;
            padding: 16px;
            text-align: left;
            font-weight: 600;
            font-size: 0.95rem;
            border-bottom: 1px solid rgba(205, 195, 190, 0.2);
        }

        .task-table td {
            padding: 16px;
            border-bottom: 1px solid rgba(205, 195, 190, 0.1);
            color: #7a6d70;
        }

        .task-table tr:hover {
            background: rgba(245, 240, 235, 0.5);
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-block;
            min-width: 70px;
            text-align: center;
        }

        .status-pending {
            background: linear-gradient(135deg, #d4c5c7 0%, #c9b8ba 100%);
            color: #8b7d7f;
        }

        .status-in-progress {
            background: linear-gradient(135deg, #c7d0c4 0%, #bcc7b9 100%);
            color: #7a8677;
        }

        .status-completed {
            background: linear-gradient(135deg, #b8c4d0 0%, #adb9c7 100%);
            color: #6d7a86;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .btn-edit, .btn-delete {
            padding: 6px 12px;
            border: none;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-edit {
            background: linear-gradient(135deg, #c9bbb0 0%, #b8a99e 100%);
            color: white;
        }

        .btn-delete {
            background: linear-gradient(135deg, #d0b8b8 0%, #c7a9a9 100%);
            color: white;
        }

        .btn-edit:hover, .btn-delete:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(139, 131, 134, 0.2);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(139, 131, 134, 0.4);
            backdrop-filter: blur(10px);
        }

        .modal-content {
            background: linear-gradient(135deg, rgba(250, 247, 244, 0.95) 0%, rgba(245, 240, 235, 0.95) 100%);
            backdrop-filter: blur(30px);
            margin: 5% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            box-shadow: 
                0 20px 60px rgba(139, 131, 134, 0.3),
                0 8px 32px rgba(139, 131, 134, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            border: 1px solid rgba(215, 204, 200, 0.3);
        }

        .close {
            color: #a69ca0;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            color: #8b8386;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #a69ca0;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .connection-test {
            background: rgba(245, 240, 235, 0.8);
            border: 1px solid rgba(215, 204, 200, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .test-button {
            padding: 10px 20px;
            background: linear-gradient(135deg, #c7d0c4 0%, #bcc7b9 100%);
            color: #7a8677;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .test-result {
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        .test-success {
            background: rgba(200, 230, 200, 0.3);
            border: 1px solid rgba(150, 200, 150, 0.5);
            color: #2d5a2d;
        }

        .test-error {
            background: rgba(255, 200, 200, 0.3);
            border: 1px solid rgba(255, 150, 150, 0.5);
            color: #8b4513;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .add-section {
                position: static;
            }
            
            .event-title {
                font-size: 2rem;
            }
            
            .filter-container {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="event-title">烤肉準備工作區</h1>
            <div class="event-date">活動：9/28(日)下午15:30 闔家烤肉萬家香</div>
            <div class="event-address">地址：新北市林口區仁愛路一段667巷23號</div>
        </div>

        <div class="main-content">
            <div class="add-section">
                <h2>新增準備事項</h2>
                
                <!-- 連接測試區 -->
                <div class="connection-test">
                    <h3 style="color: #8b8386; margin-bottom: 15px; font-size: 1.1rem;">連接測試</h3>
                    <button class="test-button" onclick="testConnection()">測試 API 連接</button>
                    <button class="test-button" onclick="testDirectCall()">直接調用測試</button>
                    <div id="testResult"></div>
                </div>
                
                <form id="taskForm">
                    <div class="form-group">
                        <label for="itemName">事項名稱</label>
                        <input type="text" id="itemName" name="itemName" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="category">分類</label>
                        <select id="category" name="category" required>
                            <option value="">選擇分類</option>
                            <option value="食材">食材</option>
                            <option value="器具">器具</option>
                            <option value="調料">調料</option>
                            <option value="其他">其他</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="quantity">數量</label>
                        <input type="text" id="quantity" name="quantity" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="responsible">負責人</label>
                        <input type="text" id="responsible" name="responsible" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="notes">備註</label>
                        <textarea id="notes" name="notes" rows="3"></textarea>
                    </div>
                    
                    <button type="submit" class="btn-add">新增事項</button>
                </form>
            </div>

            <div class="list-section">
                <div class="list-header">
                    <h2>準備清單</h2>
                    <div class="filter-container">
                        <select id="statusFilter" class="filter-select">
                            <option value="">所有狀態</option>
                            <option value="待處理">待處理</option>
                            <option value="進行中">進行中</option>
                            <option value="已完成">已完成</option>
                        </select>
                        <select id="categoryFilter" class="filter-select">
                            <option value="">所有分類</option>
                            <option value="食材">食材</option>
                            <option value="器具">器具</option>
                            <option value="調料">調料</option>
                            <option value="其他">其他</option>
                        </select>
                    </div>
                </div>
                
                <div id="taskList">
                    <div class="empty-state">
                        <div class="empty-state-icon">🔥</div>
                        <p>還沒有準備事項，趕快新增吧！</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 style="color: #8b8386; margin-bottom: 20px;">編輯事項</h2>
            <form id="editForm">
                <div class="form-group">
                    <label for="editItemName">事項名稱</label>
                    <input type="text" id="editItemName" name="itemName" required>
                </div>
                
                <div class="form-group">
                    <label for="editCategory">分類</label>
                    <select id="editCategory" name="category" required>
                        <option value="食材">食材</option>
                        <option value="器具">器具</option>
                        <option value="調料">調料</option>
                        <option value="其他">其他</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="editQuantity">數量</label>
                    <input type="text" id="editQuantity" name="quantity" required>
                </div>
                
                <div class="form-group">
                    <label for="editResponsible">負責人</label>
                    <input type="text" id="editResponsible" name="responsible" required>
                </div>
                
                <div class="form-group">
                    <label for="editNotes">備註</label>
                    <textarea id="editNotes" name="notes" rows="3"></textarea>
                </div>
                
                <button type="submit" class="btn-add">保存變更</button>
            </form>
        </div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbxRK7Q2jL7bGDigcuL6XHthkH1PJPtEEaWarfl-DDTw9CBU7FI80Rl80mVJSLpmV7ac/exec';
        let tasks = [];
        let editingRowIndex = null;

        // Test functions
        function testConnection() {
            const resultDiv = document.getElementById('testResult');
            resultDiv.innerHTML = '<div style="color: #a69ca0;">測試中...</div>';
            
            // Test simple fetch request
            fetch(API_URL + '?action=read', {
                method: 'GET',
                mode: 'no-cors'
            })
            .then(() => {
                resultDiv.innerHTML = '<div class="test-success">✅ API連接測試成功：服務器可達</div>';
                // Now try JSONP
                testJSONP();
            })
            .catch(error => {
                resultDiv.innerHTML = `<div class="test-error">❌ API連接失敗：${error.message}</div>`;
            });
        }

        function testJSONP() {
            const resultDiv = document.getElementById('testResult');
            
            try {
                const callbackName = 'testCallback_' + Date.now();
                const script = document.createElement('script');
                const url = `${API_URL}?action=read&callback=${callbackName}`;
                
                // Set timeout
                const timeout = setTimeout(() => {
                    resultDiv.innerHTML += '<div class="test-error">❌ JSONP超時：10秒內無響應</div>';
                    document.head.removeChild(script);
                    delete window[callbackName];
                }, 10000);
                
                window[callbackName] = function(data) {
                    clearTimeout(timeout);
                    document.head.removeChild(script);
                    delete window[callbackName];
                    
                    resultDiv.innerHTML += `<div class="test-success">✅ JSONP測試成功：${JSON.stringify(data, null, 2)}</div>`;
                };
                
                script.onerror = function() {
                    clearTimeout(timeout);
                    resultDiv.innerHTML += '<div class="test-error">❌ JSONP腳本載入失敗</div>';
                    document.head.removeChild(script);
                    delete window[callbackName];
                };
                
                script.src = url;
                document.head.appendChild(script);
                
            } catch (error) {
                resultDiv.innerHTML += `<div class="test-error">❌ JSONP測試異常：${error.message}</div>`;
            }
        }

        function testDirectCall() {
            const resultDiv = document.getElementById('testResult');
            resultDiv.innerHTML = '<div style="color: #a69ca0;">正在測試直接調用...</div>';
            
            // Try different approaches
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            iframe.src = API_URL + '?action=read';
            
            iframe.onload = function() {
                resultDiv.innerHTML = '<div class="test-success">✅ IFrame載入成功：服務器響應正常</div>';
                document.body.removeChild(iframe);
            };
            
            iframe.onerror = function() {
                resultDiv.innerHTML = '<div class="test-error">❌ IFrame載入失敗：服務器無響應</div>';
                document.body.removeChild(iframe);
            };
            
            document.body.appendChild(iframe);
        }

        // DOM Elements
        const taskForm = document.getElementById('taskForm');
        const taskList = document.getElementById('taskList');
        const statusFilter = document.getElementById('statusFilter');
        const categoryFilter = document.getElementById('categoryFilter');
        const editModal = document.getElementById('editModal');
        const editForm = document.getElementById('editForm');
        const closeModal = document.querySelector('.close');

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('頁面載入完成');
            
            // Auto test connection on load
            setTimeout(() => {
                testConnection();
            }, 2000);
            
            taskForm.addEventListener('submit', handleAddTask);
            editForm.addEventListener('submit', handleEditSubmit);
            statusFilter.addEventListener('change', renderTasks);
            categoryFilter.addEventListener('change', renderTasks);
            
            closeModal.addEventListener('click', closeEditModal);
            window.addEventListener('click', function(event) {
                if (event.target === editModal) {
                    closeEditModal();
                }
            });
        });

        // Simple add task function (local storage fallback)
        function handleAddTask(e) {
            e.preventDefault();
            
            const formData = new FormData(taskForm);
            const taskData = {
                id: Date.now(),
                itemName: formData.get('itemName'),
                category: formData.get('category'),
                quantity: formData.get('quantity'),
                responsible: formData.get('responsible'),
                notes: formData.get('notes') || '',
                status: '待處理',
                createdAt: new Date().toLocaleString()
            };

            // Try to add via API first, fallback to localStorage
            addTaskToAPI(taskData).catch(() => {
                addTaskToLocalStorage(taskData);
            });
        }

        function addTaskToAPI(taskData) {
            return new Promise((resolve, reject) => {
                try {
                    const callbackName = 'addCallback_' + Date.now();
                    const params = new URLSearchParams({
                        action: 'add',
                        callback: callbackName,
                        ...taskData
                    });
                    
                    const script = document.createElement('script');
                    const url = `${API_URL}?${params}`;
                    
                    const timeout = setTimeout(() => {
                        reject(new Error('API timeout'));
                        document.head.removeChild(script);
                        delete window[callbackName];
                    }, 5000);
                    
                    window[callbackName] = function(data) {
                        clearTimeout(timeout);
                        document.head.removeChild(script);
                        delete window[callbackName];
                        
                        if (data && data.success) {
                            taskForm.reset();
                            loadTasksFromAPI();
                            alert('新增成功！');
                            resolve(data);
                        } else {
                            reject(new Error(data ? data.message : '未知錯誤'));
                        }
                    };
                    
                    script.onerror = function() {
                        clearTimeout(timeout);
                        reject(new Error('Script load error'));
                        document.head.removeChild(script);
                        delete window[callbackName];
                    };
                    
                    script.src = url;
                    document.head.appendChild(script);
                    
                } catch (error) {
                    reject(error);
                }
            });
        }

        function addTaskToLocalStorage(taskData) {
            try {
                const storedTasks = JSON.parse(localStorage.getItem('bbqTasks') || '[]');
                storedTasks.push(taskData);
                localStorage.setItem('bbqTasks', JSON.stringify(storedTasks));
                
                taskForm.reset();
                loadTasksFromLocalStorage();
                alert('新增成功！（已保存到本地）');
            } catch (error) {
                alert('新增失敗: ' + error.message);
            }
        }

        function loadTasksFromAPI() {
            try {
                const callbackName = 'loadCallback_' + Date.now();
                const script = document.createElement('script');
                const url = `${API_URL}?action=read&callback=${callbackName}`;
                
                const timeout = setTimeout(() => {
                    console.log('API載入超時，切換到本地存儲');
                    loadTasksFromLocalStorage();
                    document.head.removeChild(script);
                    delete window[callbackName];
                }, 5000);
                
                window[callbackName] = function(data) {
                    clearTimeout(timeout);
                    document.head.removeChild(script);
                    delete window[callbackName];
                    
                    if (data && data.success) {
                        tasks = data.data || [];
                        renderTasks();
                    } else {
                        console.log('API載入失敗，切換到本地存儲');
                        loadTasksFromLocalStorage();
                    }
                };
                
                script.onerror = function() {
                    clearTimeout(timeout);
                    console.log('API腳本錯誤，切換到本地存儲');
                    loadTasksFromLocalStorage();
                    document.head.removeChild(script);
                    delete window[callbackName];
                };
                
                script.src = url;
                document.head.appendChild(script);
                
            } catch (error) {
                console.log('載入API時發生錯誤，切換到本地存儲:', error);
                loadTasksFromLocalStorage();
            }
        }

        function loadTasksFromLocalStorage() {
            try {
                tasks = JSON.parse(localStorage.getItem('bbqTasks') || '[]');
                renderTasks();
                
                if (tasks.length === 0) {
                    // Add some sample data
                    const sampleTasks = [
                        {
                            id: 1,
                            itemName: '牛肉片',
                            category: '食材',
                            quantity: '2公斤',
                            responsible: '爸爸',
                            notes: '選擇優質牛肉',
                            status: '待處理',
                            createdAt: new Date().toLocaleString()
                        },
                        {
                            id: 2,
                            itemName: '烤肉架',
                            category: '器具',
                            quantity: '1個',
                            responsible: '媽媽',
                            notes: '大尺寸',
                            status: '進行中',
                            createdAt: new Date().toLocaleString()
                        }
                    ];
                    
                    tasks = sampleTasks;
                    localStorage.setItem('bbqTasks', JSON.stringify(tasks));
                    renderTasks();
                }
            } catch (error) {
                console.error('載入本地存儲失敗:', error);
                tasks = [];
                renderTasks();
            }
        }

        // Render tasks
        function renderTasks() {
            const statusFilterValue = statusFilter.value;
            const categoryFilterValue = categoryFilter.value;
            
            let filteredTasks = tasks;
            
            if (statusFilterValue) {
                filteredTasks = filteredTasks.filter(task => task.status === statusFilterValue);
            }
            
            if (categoryFilterValue) {
                filteredTasks = filteredTasks.filter(task => task.category === categoryFilterValue);
            }

            if (filteredTasks.length === 0) {
                taskList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">🔥</div>
                        <p>${tasks.length === 0 ? '還沒有準備事項，趕快新增吧！' : '沒有符合篩選條件的事項'}</p>
                    </div>
                `;
                return;
            }

            const tableHTML = `
                <table class="task-table">
                    <thead>
                        <tr>
                            <th>事項名稱</th>
                            <th>分類</th>
                            <th>數量</th>
                            <th>負責人</th>
                            <th>狀態</th>
                            <th>備註</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredTasks.map((task, index) => {
                            const originalIndex = tasks.findIndex(t => t.id === task.id);
                            return `
                                <tr>
                                    <td>${task.itemName || ''}</td>
                                    <td>${task.category || ''}</td>
                                    <td>${task.quantity || ''}</td>
                                    <td>${task.responsible || ''}</td>
                                    <td>
                                        <span class="status-badge ${getStatusClass(task.status)}" 
                                              onclick="changeStatus(${originalIndex})">
                                            ${task.status || '待處理'}
                                        </span>
                                    </td>
                                    <td>${task.notes || ''}</td>
                                    <td>
                                        <div class="action-buttons">
                                            <button class="btn-edit" onclick="handleEditClick(${originalIndex})">編輯</button>
                                            <button class="btn-delete" onclick="handleDeleteClick(${originalIndex})">刪除</button>
                                        </div>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            
            taskList.innerHTML = tableHTML;
        }

        function getStatusClass(status) {
            switch(status) {
                case '待處理': return 'status-pending';
                case '進行中': return 'status-in-progress';
                case '已完成': return 'status-completed';
                default: return 'status-pending';
            }
        }

        function changeStatus(index) {
            if (index < 0 || index >= tasks.length) return;
            
            const currentStatus = tasks[index].status;
            let newStatus;
            
            switch(currentStatus) {
                case '待處理': newStatus = '進行中'; break;
                case '進行中': newStatus = '已完成'; break;
                case '已完成': newStatus = '待處理'; break;
                default: newStatus = '進行中';
            }
            
            tasks[index].status = newStatus;
            localStorage.setItem('bbqTasks', JSON.stringify(tasks));
            renderTasks();
        }

        function handleEditClick(index) {
            if (index < 0 || index >= tasks.length) return;
            
            editingRowIndex = index;
            const task = tasks[index];
            
            document.getElementById('editItemName').value = task.itemName || '';
            document.getElementById('editCategory').value = task.category || '';
            document.getElementById('editQuantity').value = task.quantity || '';
            document.getElementById('editResponsible').value = task.responsible || '';
            document.getElementById('editNotes').value = task.notes || '';
            
            editModal.style.display = 'block';
        }

        function handleEditSubmit(e) {
            e.preventDefault();
            
            if (editingRowIndex === null) return;
            
            const formData = new FormData(editForm);
            
            tasks[editingRowIndex] = {
                ...tasks[editingRowIndex],
                itemName: formData.get('itemName'),
                category: formData.get('category'),
                quantity: formData.get('quantity'),
                responsible: formData.get('responsible'),
                notes: formData.get('notes') || ''
            };
            
            localStorage.setItem('bbqTasks', JSON.stringify(tasks));
            closeEditModal();
            renderTasks();
            alert('編輯成功！');
        }

        function handleDeleteClick(index) {
            if (index < 0 || index >= tasks.length) return;
            
            const task = tasks[index];
            if (confirm(`確定要刪除「${task.itemName}」嗎？`)) {
                tasks.splice(index, 1);
                localStorage.setItem('bbqTasks', JSON.stringify(tasks));
                renderTasks();
                alert('刪除成功！');
            }
        }

        function closeEditModal() {
            editModal.style.display = 'none';
            editingRowIndex = null;
            editForm.reset();
        }

        // Initialize on load
        setTimeout(() => {
            loadTasksFromLocalStorage();
        }, 1000);
    </script>
</body>
</html>
