// 烤肉準備項目工作區 - 完整功能版 Google Apps Script
// 支援 JSONP 和完整的 CRUD 操作

// Google Sheets ID
const SHEET_ID = '1O7Dpjm-D4FvoxMargGSUmRTzJX_vr7IV7Btf_jroqis';
const SHEET_NAME = 'BBQ Tasks'; // 請確認您的工作表名稱

function doGet(e) {
  try {
    const params = e.parameter;
    const callback = params.callback || 'callback';
    
    // 如果有 action 參數，處理相應的操作
    if (params.action) {
      switch (params.action) {
        case 'add':
          return handleAddTask(params, callback);
        case 'edit':
          return handleEditTask(params, callback);
        case 'delete':
          return handleDeleteTask(params, callback);
        case 'updateStatus':
          return handleUpdateStatus(params, callback);
        default:
          return createJsonpResponse({ error: 'Unknown action: ' + params.action }, callback);
      }
    }
    
    // 默認行為：讀取所有數據
    return handleGetTasks(callback);
    
  } catch (error) {
    console.error('doGet Error:', error);
    const callback = e.parameter.callback || 'callback';
    return createJsonpResponse({ 
      error: 'Server error: ' + error.toString(),
      timestamp: new Date().toISOString()
    }, callback);
  }
}

// 處理新增任務
function handleAddTask(params, callback) {
  try {
    // 驗證必要參數
    if (!params.name) {
      return createJsonpResponse({ 
        success: false, 
        error: 'Missing required field: name' 
      }, callback);
    }
    
    const sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName(SHEET_NAME);
    
    // 準備新行數據
    const newRow = [
      params.name || '',           // 項目名稱
      params.group || '',          // 家庭分組
      params.quantity || '1',      // 數量
      params.status || '待處理',    // 狀態
      new Date().toISOString()     // 創建時間
    ];
    
    // 新增到工作表
    sheet.appendRow(newRow);
    
    console.log('Task added successfully:', newRow);
    
    return createJsonpResponse({ 
      success: true, 
      message: '項目新增成功',
      data: {
        name: params.name,
        group: params.group,
        quantity: params.quantity,
        status: params.status
      }
    }, callback);
    
  } catch (error) {
    console.error('Add task error:', error);
    return createJsonpResponse({ 
      success: false, 
      error: 'Add failed: ' + error.toString() 
    }, callback);
  }
}

// 處理編輯任務
function handleEditTask(params, callback) {
  try {
    if (!params.rowIndex) {
      return createJsonpResponse({ 
        success: false, 
        error: 'Missing row index' 
      }, callback);
    }
    
    const sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName(SHEET_NAME);
    const rowIndex = parseInt(params.rowIndex);
    
    // 驗證行號
    const lastRow = sheet.getLastRow();
    if (rowIndex < 2 || rowIndex > lastRow) {
      return createJsonpResponse({ 
        success: false, 
        error: 'Invalid row index' 
      }, callback);
    }
    
    // 更新各個欄位
    if (params.name) {
      sheet.getRange(rowIndex, 1).setValue(params.name);
    }
    if (params.group) {
      sheet.getRange(rowIndex, 2).setValue(params.group);
    }
    if (params.quantity) {
      sheet.getRange(rowIndex, 3).setValue(params.quantity);
    }
    if (params.status) {
      sheet.getRange(rowIndex, 4).setValue(params.status);
    }
    
    console.log('Task edited successfully:', params);
    
    return createJsonpResponse({ 
      success: true, 
      message: '項目編輯成功' 
    }, callback);
    
  } catch (error) {
    console.error('Edit task error:', error);
    return createJsonpResponse({ 
      success: false, 
      error: 'Edit failed: ' + error.toString() 
    }, callback);
  }
}

// 處理刪除任務
function handleDeleteTask(params, callback) {
  try {
    if (!params.rowIndex) {
      return createJsonpResponse({ 
        success: false, 
        error: 'Missing row index' 
      }, callback);
    }
    
    const sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName(SHEET_NAME);
    const rowIndex = parseInt(params.rowIndex);
    
    // 驗證行號
    const lastRow = sheet.getLastRow();
    if (rowIndex < 2 || rowIndex > lastRow) {
      return createJsonpResponse({ 
        success: false, 
        error: 'Invalid row index' 
      }, callback);
    }
    
    // 刪除行
    sheet.deleteRow(rowIndex);
    
    console.log('Task deleted successfully, row:', rowIndex);
    
    return createJsonpResponse({ 
      success: true, 
      message: '項目刪除成功' 
    }, callback);
    
  } catch (error) {
    console.error('Delete task error:', error);
    return createJsonpResponse({ 
      success: false, 
      error: 'Delete failed: ' + error.toString() 
    }, callback);
  }
}

// 處理狀態更新
function handleUpdateStatus(params, callback) {
  try {
    if (!params.rowIndex || !params.status) {
      return createJsonpResponse({ 
        success: false, 
        error: 'Missing row index or status' 
      }, callback);
    }
    
    const sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName(SHEET_NAME);
    const rowIndex = parseInt(params.rowIndex);
    
    // 驗證行號
    const lastRow = sheet.getLastRow();
    if (rowIndex < 2 || rowIndex > lastRow) {
      return createJsonpResponse({ 
        success: false, 
        error: 'Invalid row index' 
      }, callback);
    }
    
    // 更新狀態（第4列）
    sheet.getRange(rowIndex, 4).setValue(params.status);
    
    console.log('Status updated successfully:', params);
    
    return createJsonpResponse({ 
      success: true, 
      message: '狀態更新成功',
      newStatus: params.status
    }, callback);
    
  } catch (error) {
    console.error('Update status error:', error);
    return createJsonpResponse({ 
      success: false, 
      error: 'Status update failed: ' + error.toString() 
    }, callback);
  }
}

// 處理讀取所有任務
function handleGetTasks(callback) {
  try {
    const sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName(SHEET_NAME);
    const data = sheet.getDataRange().getValues();
    
    if (data.length <= 1) {
      return createJsonpResponse([], callback);
    }
    
    // 轉換為物件陣列，包含行號信息
    const tasks = [];
    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      tasks.push({
        rowIndex: i + 1, // 行號（1-based）
        name: row[0] || '',
        group: row[1] || '',
        quantity: row[2] || '1',
        status: row[3] || '待處理',
        createdAt: row[4] || ''
      });
    }
    
    console.log('Tasks retrieved:', tasks.length);
    return createJsonpResponse(tasks, callback);
    
  } catch (error) {
    console.error('Get tasks error:', error);
    return createJsonpResponse({ 
      error: 'Failed to retrieve tasks: ' + error.toString() 
    }, callback);
  }
}

// 創建 JSONP 響應
function createJsonpResponse(data, callback) {
  const jsonData = JSON.stringify(data);
  const response = `${callback}(${jsonData});`;
  
  return ContentService
    .createTextOutput(response)
    .setMimeType(ContentService.MimeType.JAVASCRIPT);
}

// 測試函數（可選）
function testOperations() {
  // 測試新增
  console.log('Testing add...');
  const addResult = handleAddTask({
    name: '測試項目',
    group: '測試組',
    quantity: '1',
    status: '待處理'
  }, 'testCallback');
  
  // 測試讀取
  console.log('Testing get...');
  const getResult = handleGetTasks('testCallback');
  console.log('Get result:', getResult.getContent());
}
