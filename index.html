<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çƒ¤è‚‰æº–å‚™å·¥ä½œå€ - è«è˜­è¿ªé¢¨æ ¼</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, 
                #f5f2f0 0%, 
                #ede7e0 25%, 
                #e8ddd4 50%, 
                #e2d6ca 75%, 
                #ddd0c0 100%);
            min-height: 100vh;
            color: #6b5b6f;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(215, 204, 200, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(205, 195, 185, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 40% 80%, rgba(195, 185, 175, 0.2) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            background: rgba(245, 240, 235, 0.6);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 30px;
            box-shadow: 
                0 8px 32px rgba(139, 131, 134, 0.1),
                0 4px 16px rgba(139, 131, 134, 0.05),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(215, 204, 200, 0.2);
        }

        .event-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: #8b8386;
            margin-bottom: 15px;
            text-shadow: 0 2px 4px rgba(139, 131, 134, 0.1);
        }

        .event-date {
            font-size: 1.3rem;
            color: #a69ca0;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .event-address {
            font-size: 1.1rem;
            color: #b8aeb3;
            font-weight: 400;
        }

        .debug-info {
            background: rgba(255, 245, 245, 0.8);
            border: 1px solid rgba(255, 180, 180, 0.3);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            color: #8b4513;
            display: none;
        }

        .debug-info.show {
            display: block;
        }

        .main-content {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 30px;
            align-items: start;
        }

        .add-section {
            background: rgba(240, 235, 230, 0.7);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 
                0 8px 32px rgba(139, 131, 134, 0.1),
                0 4px 16px rgba(139, 131, 134, 0.05),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(215, 204, 200, 0.3);
            position: sticky;
            top: 20px;
        }

        .add-section h2 {
            color: #8b8386;
            font-size: 1.4rem;
            margin-bottom: 25px;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #9d9396;
            font-weight: 500;
            font-size: 0.95rem;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1.5px solid rgba(205, 195, 190, 0.4);
            border-radius: 12px;
            background: rgba(248, 245, 242, 0.8);
            backdrop-filter: blur(10px);
            color: #7a6d70;
            font-size: 1rem;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: rgba(165, 155, 150, 0.6);
            background: rgba(250, 247, 244, 0.9);
            box-shadow: 0 0 0 3px rgba(165, 155, 150, 0.1);
        }

        .btn-add {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #c9bbb0 0%, #b8a99e 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            box-shadow: 
                0 4px 12px rgba(139, 131, 134, 0.2),
                0 2px 4px rgba(139, 131, 134, 0.1);
        }

        .btn-add:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 6px 20px rgba(139, 131, 134, 0.25),
                0 4px 8px rgba(139, 131, 134, 0.15);
        }

        .btn-add:active {
            transform: translateY(0);
        }

        .btn-debug {
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            background: linear-gradient(135deg, #d4c5c7 0%, #c9b8ba 100%);
            color: #8b7d7f;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .list-section {
            background: rgba(250, 247, 244, 0.6);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 
                0 8px 32px rgba(139, 131, 134, 0.1),
                0 4px 16px rgba(139, 131, 134, 0.05),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(215, 204, 200, 0.3);
        }

        .list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .list-section h2 {
            color: #8b8386;
            font-size: 1.4rem;
            font-weight: 600;
        }

        .filter-container {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .filter-select {
            min-width: 120px;
            padding: 8px 12px;
            border: 1.5px solid rgba(205, 195, 190, 0.4);
            border-radius: 8px;
            background: rgba(248, 245, 242, 0.8);
            color: #7a6d70;
            font-size: 0.9rem;
        }

        .task-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255, 255, 255, 0.4);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 
                0 4px 16px rgba(139, 131, 134, 0.08),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        .task-table th {
            background: linear-gradient(135deg, rgba(220, 210, 200, 0.7) 0%, rgba(210, 200, 190, 0.7) 100%);
            color: #8b8386;
            padding: 16px;
            text-align: left;
            font-weight: 600;
            font-size: 0.95rem;
            border-bottom: 1px solid rgba(205, 195, 190, 0.2);
        }

        .task-table td {
            padding: 16px;
            border-bottom: 1px solid rgba(205, 195, 190, 0.1);
            color: #7a6d70;
        }

        .task-table tr:hover {
            background: rgba(245, 240, 235, 0.5);
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-block;
            min-width: 70px;
            text-align: center;
        }

        .status-pending {
            background: linear-gradient(135deg, #d4c5c7 0%, #c9b8ba 100%);
            color: #8b7d7f;
        }

        .status-in-progress {
            background: linear-gradient(135deg, #c7d0c4 0%, #bcc7b9 100%);
            color: #7a8677;
        }

        .status-completed {
            background: linear-gradient(135deg, #b8c4d0 0%, #adb9c7 100%);
            color: #6d7a86;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .btn-edit, .btn-delete {
            padding: 6px 12px;
            border: none;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-edit {
            background: linear-gradient(135deg, #c9bbb0 0%, #b8a99e 100%);
            color: white;
        }

        .btn-delete {
            background: linear-gradient(135deg, #d0b8b8 0%, #c7a9a9 100%);
            color: white;
        }

        .btn-edit:hover, .btn-delete:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(139, 131, 134, 0.2);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(139, 131, 134, 0.4);
            backdrop-filter: blur(10px);
        }

        .modal-content {
            background: linear-gradient(135deg, rgba(250, 247, 244, 0.95) 0%, rgba(245, 240, 235, 0.95) 100%);
            backdrop-filter: blur(30px);
            margin: 5% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            box-shadow: 
                0 20px 60px rgba(139, 131, 134, 0.3),
                0 8px 32px rgba(139, 131, 134, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            border: 1px solid rgba(215, 204, 200, 0.3);
        }

        .close {
            color: #a69ca0;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            color: #8b8386;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #a69ca0;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .loading {
            text-align: center;
            padding: 40px 20px;
            color: #a69ca0;
        }

        .error-state {
            text-align: center;
            padding: 40px 20px;
            color: #d0b8b8;
            background: rgba(255, 245, 245, 0.5);
            border-radius: 12px;
            border: 1px solid rgba(255, 180, 180, 0.2);
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .add-section {
                position: static;
            }
            
            .event-title {
                font-size: 2rem;
            }
            
            .filter-container {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="event-title">çƒ¤è‚‰æº–å‚™å·¥ä½œå€</h1>
            <div class="event-date">æ´»å‹•ï¼š9/28(æ—¥)ä¸‹åˆ15:30 é—”å®¶çƒ¤è‚‰è¬å®¶é¦™</div>
            <div class="event-address">åœ°å€ï¼šæ–°åŒ—å¸‚æ—å£å€ä»æ„›è·¯ä¸€æ®µ667å··23è™Ÿ</div>
        </div>

        <div id="debugInfo" class="debug-info">
            <strong>èª¿è©¦ä¿¡æ¯ï¼š</strong><br>
            <div id="debugContent"></div>
        </div>

        <div class="main-content">
            <div class="add-section">
                <h2>æ–°å¢æº–å‚™äº‹é …</h2>
                <form id="taskForm">
                    <div class="form-group">
                        <label for="itemName">äº‹é …åç¨±</label>
                        <input type="text" id="itemName" name="itemName" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="category">åˆ†é¡</label>
                        <select id="category" name="category" required>
                            <option value="">é¸æ“‡åˆ†é¡</option>
                            <option value="é£Ÿæ">é£Ÿæ</option>
                            <option value="å™¨å…·">å™¨å…·</option>
                            <option value="èª¿æ–™">èª¿æ–™</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="quantity">æ•¸é‡</label>
                        <input type="text" id="quantity" name="quantity" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="responsible">è² è²¬äºº</label>
                        <input type="text" id="responsible" name="responsible" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="notes">å‚™è¨»</label>
                        <textarea id="notes" name="notes" rows="3"></textarea>
                    </div>
                    
                    <button type="submit" class="btn-add">æ–°å¢äº‹é …</button>
                    <button type="button" class="btn-debug" onclick="toggleDebug()">é¡¯ç¤ºèª¿è©¦ä¿¡æ¯</button>
                </form>
            </div>

            <div class="list-section">
                <div class="list-header">
                    <h2>æº–å‚™æ¸…å–®</h2>
                    <div class="filter-container">
                        <select id="statusFilter" class="filter-select">
                            <option value="">æ‰€æœ‰ç‹€æ…‹</option>
                            <option value="å¾…è™•ç†">å¾…è™•ç†</option>
                            <option value="é€²è¡Œä¸­">é€²è¡Œä¸­</option>
                            <option value="å·²å®Œæˆ">å·²å®Œæˆ</option>
                        </select>
                        <select id="categoryFilter" class="filter-select">
                            <option value="">æ‰€æœ‰åˆ†é¡</option>
                            <option value="é£Ÿæ">é£Ÿæ</option>
                            <option value="å™¨å…·">å™¨å…·</option>
                            <option value="èª¿æ–™">èª¿æ–™</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                    </div>
                </div>
                
                <div id="taskList">
                    <div class="loading">
                        <div style="font-size: 2rem; margin-bottom: 15px;">â³</div>
                        <p>æ­£åœ¨è¼‰å…¥æ•¸æ“š...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 style="color: #8b8386; margin-bottom: 20px;">ç·¨è¼¯äº‹é …</h2>
            <form id="editForm">
                <div class="form-group">
                    <label for="editItemName">äº‹é …åç¨±</label>
                    <input type="text" id="editItemName" name="itemName" required>
                </div>
                
                <div class="form-group">
                    <label for="editCategory">åˆ†é¡</label>
                    <select id="editCategory" name="category" required>
                        <option value="é£Ÿæ">é£Ÿæ</option>
                        <option value="å™¨å…·">å™¨å…·</option>
                        <option value="èª¿æ–™">èª¿æ–™</option>
                        <option value="å…¶ä»–">å…¶ä»–</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="editQuantity">æ•¸é‡</label>
                    <input type="text" id="editQuantity" name="quantity" required>
                </div>
                
                <div class="form-group">
                    <label for="editResponsible">è² è²¬äºº</label>
                    <input type="text" id="editResponsible" name="responsible" required>
                </div>
                
                <div class="form-group">
                    <label for="editNotes">å‚™è¨»</label>
                    <textarea id="editNotes" name="notes" rows="3"></textarea>
                </div>
                
                <button type="submit" class="btn-add">ä¿å­˜è®Šæ›´</button>
            </form>
        </div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbxRK7Q2jL7bGDigcuL6XHthkH1PJPtEEaWarfl-DDTw9CBU7FI80Rl80mVJSLpmV7ac/exec';
        let tasks = [];
        let editingRowIndex = null;
        let debugMode = false;

        // Debug functions
        function log(message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            console.log(logMessage, data || '');
            
            if (debugMode) {
                const debugContent = document.getElementById('debugContent');
                const logEntry = document.createElement('div');
                logEntry.innerHTML = `${logMessage}${data ? ' ' + JSON.stringify(data, null, 2) : ''}`;
                debugContent.appendChild(logEntry);
                debugContent.scrollTop = debugContent.scrollHeight;
            }
        }

        function toggleDebug() {
            debugMode = !debugMode;
            const debugInfo = document.getElementById('debugInfo');
            const btn = event.target;
            
            if (debugMode) {
                debugInfo.classList.add('show');
                btn.textContent = 'éš±è—èª¿è©¦ä¿¡æ¯';
                log('èª¿è©¦æ¨¡å¼å·²é–‹å•Ÿ');
            } else {
                debugInfo.classList.remove('show');
                btn.textContent = 'é¡¯ç¤ºèª¿è©¦ä¿¡æ¯';
                document.getElementById('debugContent').innerHTML = '';
            }
        }

        // DOM Elements
        const taskForm = document.getElementById('taskForm');
        const taskList = document.getElementById('taskList');
        const statusFilter = document.getElementById('statusFilter');
        const categoryFilter = document.getElementById('categoryFilter');
        const editModal = document.getElementById('editModal');
        const editForm = document.getElementById('editForm');
        const closeModal = document.querySelector('.close');

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            log('é é¢è¼‰å…¥å®Œæˆï¼Œé–‹å§‹åˆå§‹åŒ–');
            
            // Add timeout for loading
            setTimeout(() => {
                if (tasks.length === 0) {
                    showError('è¼‰å…¥è¶…æ™‚ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡é€£æ¥æˆ–é‡æ–°æ•´ç†é é¢');
                }
            }, 10000);
            
            loadTasks();
            
            taskForm.addEventListener('submit', handleAddTask);
            editForm.addEventListener('submit', handleEditSubmit);
            statusFilter.addEventListener('change', renderTasks);
            categoryFilter.addEventListener('change', renderTasks);
            
            closeModal.addEventListener('click', closeEditModal);
            window.addEventListener('click', function(event) {
                if (event.target === editModal) {
                    closeEditModal();
                }
            });
        });

        // Load tasks from Google Apps Script
        function loadTasks() {
            log('é–‹å§‹è¼‰å…¥ä»»å‹™æ•¸æ“š');
            
            try {
                const callbackName = 'handleTasksLoaded_' + Date.now();
                const script = document.createElement('script');
                const url = `${API_URL}?action=read&callback=${callbackName}`;
                
                log('ç™¼é€JSONPè«‹æ±‚', { url: url });
                
                // Create global callback function
                window[callbackName] = function(data) {
                    log('æ”¶åˆ°å›èª¿æ•¸æ“š', data);
                    
                    // Clean up
                    document.head.removeChild(script);
                    delete window[callbackName];
                    
                    handleTasksLoaded(data);
                };
                
                // Set up error handling
                script.onerror = function() {
                    log('è…³æœ¬è¼‰å…¥éŒ¯èª¤');
                    showError('ç„¡æ³•é€£æ¥åˆ°æœå‹™å™¨ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡é€£æ¥');
                    document.head.removeChild(script);
                    delete window[callbackName];
                };
                
                script.src = url;
                document.head.appendChild(script);
                
            } catch (error) {
                log('è¼‰å…¥ä»»å‹™æ™‚ç™¼ç”ŸéŒ¯èª¤', error);
                showError('è¼‰å…¥æ•¸æ“šæ™‚ç™¼ç”ŸéŒ¯èª¤: ' + error.message);
            }
        }

        // Handle loaded tasks
        function handleTasksLoaded(data) {
            log('è™•ç†è¼‰å…¥çš„ä»»å‹™æ•¸æ“š', data);
            
            if (!data) {
                log('æ”¶åˆ°ç©ºæ•¸æ“š');
                showError('æœå‹™å™¨è¿”å›ç©ºæ•¸æ“šï¼Œè«‹ç¨å¾Œå†è©¦');
                return;
            }
            
            if (data.success) {
                tasks = data.data || [];
                log('ä»»å‹™è¼‰å…¥æˆåŠŸ', { count: tasks.length });
                renderTasks();
            } else {
                const errorMsg = data.message || 'æœªçŸ¥éŒ¯èª¤';
                log('è¼‰å…¥å¤±æ•—', { message: errorMsg });
                showError('è¼‰å…¥è³‡æ–™å¤±æ•—: ' + errorMsg);
            }
        }

        // Show error message
        function showError(message) {
            taskList.innerHTML = `
                <div class="error-state">
                    <div style="font-size: 2rem; margin-bottom: 15px;">âš ï¸</div>
                    <p><strong>è¼‰å…¥å¤±æ•—</strong></p>
                    <p>${message}</p>
                    <button style="margin-top: 15px; padding: 8px 16px; background: #c7a9a9; color: white; border: none; border-radius: 8px; cursor: pointer;" onclick="loadTasks()">é‡æ–°è¼‰å…¥</button>
                </div>
            `;
        }

        // Handle add task form submission
        function handleAddTask(e) {
            e.preventDefault();
            log('æäº¤æ–°å¢ä»»å‹™è¡¨å–®');
            
            const formData = new FormData(taskForm);
            const taskData = {
                itemName: formData.get('itemName'),
                category: formData.get('category'),
                quantity: formData.get('quantity'),
                responsible: formData.get('responsible'),
                notes: formData.get('notes') || '',
                status: 'å¾…è™•ç†'
            };

            log('æ–°å¢ä»»å‹™æ•¸æ“š', taskData);
            addTask(taskData);
        }

        // Add task via JSONP
        function addTask(taskData) {
            try {
                const callbackName = 'handleAddResult_' + Date.now();
                const params = new URLSearchParams({
                    action: 'add',
                    callback: callbackName,
                    ...taskData
                });
                
                const url = `${API_URL}?${params}`;
                log('ç™¼é€æ–°å¢è«‹æ±‚', { url: url });
                
                window[callbackName] = function(data) {
                    log('æ”¶åˆ°æ–°å¢çµæœ', data);
                    document.head.removeChild(script);
                    delete window[callbackName];
                    handleAddResult(data);
                };
                
                const script = document.createElement('script');
                script.onerror = function() {
                    log('æ–°å¢è«‹æ±‚è…³æœ¬éŒ¯èª¤');
                    alert('æ–°å¢å¤±æ•—ï¼šç¶²çµ¡éŒ¯èª¤');
                    document.head.removeChild(script);
                    delete window[callbackName];
                };
                
                script.src = url;
                document.head.appendChild(script);
                
            } catch (error) {
                log('æ–°å¢ä»»å‹™æ™‚ç™¼ç”ŸéŒ¯èª¤', error);
                alert('æ–°å¢å¤±æ•—: ' + error.message);
            }
        }

        // Callback for add task result
        function handleAddResult(data) {
            if (data && data.success) {
                taskForm.reset();
                loadTasks(); // Reload tasks
                alert('æ–°å¢æˆåŠŸï¼');
            } else {
                const errorMsg = data ? data.message : 'æœªçŸ¥éŒ¯èª¤';
                log('æ–°å¢å¤±æ•—', { message: errorMsg });
                alert('æ–°å¢å¤±æ•—: ' + errorMsg);
            }
        }

        // Render tasks table
        function renderTasks() {
            log('æ¸²æŸ“ä»»å‹™åˆ—è¡¨', { taskCount: tasks.length });
            
            const statusFilterValue = statusFilter.value;
            const categoryFilterValue = categoryFilter.value;
            
            let filteredTasks = tasks;
            
            if (statusFilterValue) {
                filteredTasks = filteredTasks.filter(task => task.status === statusFilterValue);
            }
            
            if (categoryFilterValue) {
                filteredTasks = filteredTasks.filter(task => task.category === categoryFilterValue);
            }

            if (filteredTasks.length === 0) {
                taskList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ”¥</div>
                        <p>${tasks.length === 0 ? 'é‚„æ²’æœ‰æº–å‚™äº‹é …ï¼Œè¶•å¿«æ–°å¢å§ï¼' : 'æ²’æœ‰ç¬¦åˆç¯©é¸æ¢ä»¶çš„äº‹é …'}</p>
                    </div>
                `;
                return;
            }

            const tableHTML = `
                <table class="task-table">
                    <thead>
                        <tr>
                            <th>äº‹é …åç¨±</th>
                            <th>åˆ†é¡</th>
                            <th>æ•¸é‡</th>
                            <th>è² è²¬äºº</th>
                            <th>ç‹€æ…‹</th>
                            <th>å‚™è¨»</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredTasks.map((task, index) => {
                            const originalIndex = tasks.findIndex(t => 
                                t.itemName === task.itemName && 
                                t.category === task.category && 
                                t.responsible === task.responsible
                            );
                            return `
                                <tr>
                                    <td>${task.itemName || ''}</td>
                                    <td>${task.category || ''}</td>
                                    <td>${task.quantity || ''}</td>
                                    <td>${task.responsible || ''}</td>
                                    <td>
                                        <span class="status-badge ${getStatusClass(task.status)}" 
                                              onclick="changeStatus(${originalIndex})">
                                            ${task.status || 'å¾…è™•ç†'}
                                        </span>
                                    </td>
                                    <td>${task.notes || ''}</td>
                                    <td>
                                        <div class="action-buttons">
                                            <button class="btn-edit" onclick="handleEditClick(${originalIndex})">ç·¨è¼¯</button>
                                            <button class="btn-delete" onclick="handleDeleteClick(${originalIndex})">åˆªé™¤</button>
                                        </div>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            
            taskList.innerHTML = tableHTML;
        }

        // Get status CSS class
        function getStatusClass(status) {
            switch(status) {
                case 'å¾…è™•ç†': return 'status-pending';
                case 'é€²è¡Œä¸­': return 'status-in-progress';
                case 'å·²å®Œæˆ': return 'status-completed';
                default: return 'status-pending';
            }
        }

        // Change task status
        function changeStatus(rowIndex) {
            log('æ›´æ”¹ç‹€æ…‹', { rowIndex: rowIndex });
            
            if (rowIndex < 0 || rowIndex >= tasks.length) {
                log('ç„¡æ•ˆçš„è¡Œç´¢å¼•', { rowIndex: rowIndex, tasksLength: tasks.length });
                return;
            }

            const currentStatus = tasks[rowIndex].status;
            let newStatus;
            
            switch(currentStatus) {
                case 'å¾…è™•ç†':
                    newStatus = 'é€²è¡Œä¸­';
                    break;
                case 'é€²è¡Œä¸­':
                    newStatus = 'å·²å®Œæˆ';
                    break;
                case 'å·²å®Œæˆ':
                    newStatus = 'å¾…è™•ç†';
                    break;
                default:
                    newStatus = 'é€²è¡Œä¸­';
            }

            updateStatus(rowIndex, newStatus);
        }

        // Update status via JSONP
        function updateStatus(rowIndex, newStatus) {
            try {
                const callbackName = 'handleUpdateStatusResult_' + Date.now();
                const params = new URLSearchParams({
                    action: 'updateStatus',
                    callback: callbackName,
                    rowIndex: rowIndex + 2,
                    status: newStatus
                });
                
                const url = `${API_URL}?${params}`;
                log('ç™¼é€ç‹€æ…‹æ›´æ–°è«‹æ±‚', { url: url, rowIndex: rowIndex, newStatus: newStatus });
                
                window[callbackName] = function(data) {
                    log('æ”¶åˆ°ç‹€æ…‹æ›´æ–°çµæœ', data);
                    document.head.removeChild(script);
                    delete window[callbackName];
                    handleUpdateStatusResult(data);
                };
                
                const script = document.createElement('script');
                script.onerror = function() {
                    log('ç‹€æ…‹æ›´æ–°è…³æœ¬éŒ¯èª¤');
                    alert('æ›´æ–°ç‹€æ…‹å¤±æ•—ï¼šç¶²çµ¡éŒ¯èª¤');
                    document.head.removeChild(script);
                    delete window[callbackName];
                };
                
                script.src = url;
                document.head.appendChild(script);
                
            } catch (error) {
                log('æ›´æ–°ç‹€æ…‹æ™‚ç™¼ç”ŸéŒ¯èª¤', error);
                alert('æ›´æ–°ç‹€æ…‹å¤±æ•—: ' + error.message);
            }
        }

        // Callback for update status result
        function handleUpdateStatusResult(data) {
            if (data && data.success) {
                loadTasks(); // Reload tasks
            } else {
                const errorMsg = data ? data.message : 'æœªçŸ¥éŒ¯èª¤';
                log('æ›´æ–°ç‹€æ…‹å¤±æ•—', { message: errorMsg });
                alert('æ›´æ–°ç‹€æ…‹å¤±æ•—: ' + errorMsg);
            }
        }

        // Handle edit button click
        function handleEditClick(rowIndex) {
            log('é»æ“Šç·¨è¼¯æŒ‰éˆ•', { rowIndex: rowIndex });
            
            if (rowIndex < 0 || rowIndex >= tasks.length) {
                log('ç„¡æ•ˆçš„ç·¨è¼¯è¡Œç´¢å¼•', { rowIndex: rowIndex, tasksLength: tasks.length });
                return;
            }

            editingRowIndex = rowIndex;
            const task = tasks[rowIndex];
            
            document.getElementById('editItemName').value = task.itemName || '';
            document.getElementById('editCategory').value = task.category || '';
            document.getElementById('editQuantity').value = task.quantity || '';
            document.getElementById('editResponsible').value = task.responsible || '';
            document.getElementById('editNotes').value = task.notes || '';
            
            editModal.style.display = 'block';
        }

        // Handle edit form submission
        function handleEditSubmit(e) {
            e.preventDefault();
            log('æäº¤ç·¨è¼¯è¡¨å–®', { editingRowIndex: editingRowIndex });
            
            if (editingRowIndex === null) return;
            
            const formData = new FormData(editForm);
            const updatedTask = {
                itemName: formData.get('itemName'),
                category: formData.get('category'),
                quantity: formData.get('quantity'),
                responsible: formData.get('responsible'),
                notes: formData.get('notes') || ''
            };

            editTask(editingRowIndex, updatedTask);
        }

        // Edit task via JSONP
        function editTask(rowIndex, taskData) {
            try {
                const callbackName = 'handleEditResult_' + Date.now();
                const params = new URLSearchParams({
                    action: 'edit',
                    callback: callbackName,
                    rowIndex: rowIndex + 2,
                    ...taskData
                });
                
                const url = `${API_URL}?${params}`;
                log('ç™¼é€ç·¨è¼¯è«‹æ±‚', { url: url, rowIndex: rowIndex, taskData: taskData });
                
                window[callbackName] = function(data) {
                    log('æ”¶åˆ°ç·¨è¼¯çµæœ', data);
                    document.head.removeChild(script);
                    delete window[callbackName];
                    handleEditResult(data);
                };
                
                const script = document.createElement('script');
                script.onerror = function() {
                    log('ç·¨è¼¯è«‹æ±‚è…³æœ¬éŒ¯èª¤');
                    alert('ç·¨è¼¯å¤±æ•—ï¼šç¶²çµ¡éŒ¯èª¤');
                    document.head.removeChild(script);
                    delete window[callbackName];
                };
                
                script.src = url;
                document.head.appendChild(script);
                
            } catch (error) {
                log('ç·¨è¼¯ä»»å‹™æ™‚ç™¼ç”ŸéŒ¯èª¤', error);
                alert('ç·¨è¼¯å¤±æ•—: ' + error.message);
            }
        }

        // Callback for edit task result
        function handleEditResult(data) {
            if (data && data.success) {
                closeEditModal();
                loadTasks(); // Reload tasks
                alert('ç·¨è¼¯æˆåŠŸï¼');
            } else {
                const errorMsg = data ? data.message : 'æœªçŸ¥éŒ¯èª¤';
                log('ç·¨è¼¯å¤±æ•—', { message: errorMsg });
                alert('ç·¨è¼¯å¤±æ•—: ' + errorMsg);
            }
        }

        // Handle delete button click
        function handleDeleteClick(rowIndex) {
            log('é»æ“Šåˆªé™¤æŒ‰éˆ•', { rowIndex: rowIndex });
            
            if (rowIndex < 0 || rowIndex >= tasks.length) {
                log('ç„¡æ•ˆçš„åˆªé™¤è¡Œç´¢å¼•', { rowIndex: rowIndex, tasksLength: tasks.length });
                return;
            }

            const task = tasks[rowIndex];
            if (confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${task.itemName}ã€å—ï¼Ÿ`)) {
                deleteTask(rowIndex);
            }
        }

        // Delete task via JSONP
        function deleteTask(rowIndex) {
            try {
                const callbackName = 'handleDeleteResult_' + Date.now();
                const params = new URLSearchParams({
                    action: 'delete',
                    callback: callbackName,
                    rowIndex: rowIndex + 2
                });
                
                const url = `${API_URL}?${params}`;
                log('ç™¼é€åˆªé™¤è«‹æ±‚', { url: url, rowIndex: rowIndex });
                
                window[callbackName] = function(data) {
                    log('æ”¶åˆ°åˆªé™¤çµæœ', data);
                    document.head.removeChild(script);
                    delete window[callbackName];
                    handleDeleteResult(data);
                };
                
                const script = document.createElement('script');
                script.onerror = function() {
                    log('åˆªé™¤è«‹æ±‚è…³æœ¬éŒ¯èª¤');
                    alert('åˆªé™¤å¤±æ•—ï¼šç¶²çµ¡éŒ¯èª¤');
                    document.head.removeChild(script);
                    delete window[callbackName];
                };
                
                script.src = url;
                document.head.appendChild(script);
                
            } catch (error) {
                log('åˆªé™¤ä»»å‹™æ™‚ç™¼ç”ŸéŒ¯èª¤', error);
                alert('åˆªé™¤å¤±æ•—: ' + error.message);
            }
        }

        // Callback for delete task result
        function handleDeleteResult(data) {
            if (data && data.success) {
                loadTasks(); // Reload tasks
                alert('åˆªé™¤æˆåŠŸï¼');
            } else {
                const errorMsg = data ? data.message : 'æœªçŸ¥éŒ¯èª¤';
                log('åˆªé™¤å¤±æ•—', { message: errorMsg });
                alert('åˆªé™¤å¤±æ•—: ' + errorMsg);
            }
        }

        // Close edit modal
        function closeEditModal() {
            editModal.style.display = 'none';
            editingRowIndex = null;
            editForm.reset();
        }
    </script>
</body>
</html>
